(function () {
  'use strict';

  const BASE_URL = 'https://script.google.com/macros/s/AKfycbxwQvH_Eev-0NwD8Zv58BKtok31UvBguApH_mxDr0n0ryfRVVNj7AYx6cwh7XVHvibL/exec';
  const GEMINI_API_KEY = "AIzaSyDCofB7HU-vllo7b5kx6RRwo0lp5jAMdfo";
  const GEMINI_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

  let candidateData = [];
  let confirmedData = [];

  const container = document.createElement("div");
  container.style = "width: 100%; padding: 10px; background: #f4f4f4; border-bottom: 1px solid #ccc;";
  document.querySelector('.path')?.before(container);

   container.innerHTML = `
    <div id="blogToolBar" style="display: flex; flex-wrap: wrap; gap: 10px;">
      <button id="addCandidate">ğŸ“ å€™è£œã«ç™»éŒ²</button>
      <button id="confirmSelected">âœ… ä¸€æ‹¬ç¢ºå®š</button>
      <button id="deleteSelected">ğŸ—‘ï¸ é¸æŠå‰Šé™¤</button>
      <button id="thankYouBtn">å›ºå®šã‚¿ã‚°è¿½åŠ </button>
      <button id="aiBlogBtn">ğŸ¤– AIã§ãƒ–ãƒ­ã‚°ã‚’æ›¸ã(Î²ç‰ˆ)</button>
    </div>
    <div id="aiSection" style="margin-top: 10px;">
      <textarea id="aiPromptInput" placeholder="ã©ã‚“ãªè¨˜äº‹ã‚’æ›¸ããŸã„ã§ã™ã‹ï¼Ÿï¼ˆä¾‹ï¼šæ¢…é›¨ã®é«ªè³ªæ”¹å–„ã‚±ã‚¢ï¼‰"
        style="display:none;width:100%;height:80px;margin-top:5px;"></textarea>
      <button id="aiExecBtn" style="display:none; margin-top: 5px;">ã“ã®å†…å®¹ã§æ›¸ã</button>
    </div>
    <div id="candidateList"><h3>å€™è£œä¸€è¦§</h3></div>
    <div id="confirmedList"><h3>ç¢ºå®šæ¸ˆã¿ä¸€è¦§</h3></div>
  `;


  function showLoading(msg = "å‡¦ç†ä¸­...") {
    let loading = document.getElementById("blog-loading");
    if (!loading) {
      loading = document.createElement("div");
      loading.id = "blog-loading";
      loading.style.cssText = "position:fixed;top:20px;right:20px;background:#000;color:#fff;padding:10px;z-index:9999;border-radius:5px;font-size:14px;";
      document.body.appendChild(loading);
    }
    loading.textContent = msg;
  }

  function hideLoading() {
    const loading = document.getElementById("blog-loading");
    if (loading) loading.remove();
  }

  function renderLoadingList(elementId, label = "èª­ã¿è¾¼ã¿ä¸­...") {
    const root = document.getElementById(elementId);
    root.innerHTML = `<h3>${label}</h3><div>ğŸ”„ ${label}</div>`;
  }

  function getFormData() {
    return {
      action: 'add_candidate',
      title: document.querySelector('input[name="title"]')?.value || '',
      content: document.querySelector('.nicEdit-main')?.innerHTML || '',
      stylistId: document.querySelector('#stylistId')?.value || '',
      category: document.querySelector('#blogCategoryCd')?.value || '',
      images: document.querySelector('img.img-resize219')?.src || '',
      couponId: document.querySelector('input[name="couponId"]')?.value || ''
    };
  }

  function renderList(list, elementId, isCandidate) {
    const root = document.getElementById(elementId);
    const items = list.map((item, i) => `
      <div style="border: 1px solid #ccc; padding: 5px;">
        <input type="checkbox" data-index="${item.index}">
        <strong>${item.title}</strong><br>
        <img src="${item.image}" width="100"><br>
        ${isCandidate ? `
          <button data-move="up" data-i="${i}">â†</button>
          <button data-move="down" data-i="${i}">â†’</button>
        ` : ''}
      </div>
    `).join('');
    root.innerHTML = `<h3>${isCandidate ? 'å€™è£œä¸€è¦§' : 'ç¢ºå®šæ¸ˆã¿ä¸€è¦§'}</h3><div style="display: flex; gap: 10px; flex-wrap: wrap;">${items}</div>`;

    if (isCandidate) {
      root.querySelectorAll('button[data-move]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = parseInt(btn.dataset.i);
          const dir = btn.dataset.move;
          if (dir === 'up' && i > 0) {
            [candidateData[i], candidateData[i - 1]] = [candidateData[i - 1], candidateData[i]];
          } else if (dir === 'down' && i < candidateData.length - 1) {
            [candidateData[i], candidateData[i + 1]] = [candidateData[i + 1], candidateData[i]];
          }
          updateOrder();
        });
      });
    }
  }

  function updateOrder() {
    const indexList = candidateData.map(c => c.index);
    showLoading("é †ç•ªã‚’ä¿å­˜ä¸­...");
    fetch(BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'reorder',
        indexList: JSON.stringify(indexList)
      })
    }).then(() => {
      hideLoading();
      loadData();
    });
  }

  function loadData() {
    renderLoadingList("candidateList", "å€™è£œä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...");
    renderLoadingList("confirmedList", "ç¢ºå®šæ¸ˆã¿ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...");
    fetch(BASE_URL + '?action=get')
      .then(res => res.json())
      .then(data => {
        candidateData = data.candidates || [];
        confirmedData = data.confirmed || [];
        renderList(candidateData, "candidateList", true);
        renderList(confirmedData, "confirmedList", false);
      });
  }

  // å›ºå®šã‚¿ã‚°è¿½åŠ 
  document.getElementById("thankYouBtn").onclick = () => {
    const editor = document.querySelector('.nicEdit-main');
    if (editor) {
      editor.innerHTML += '<br>ç™½é«ªæŸ“ã‚ã€€ç™½é«ªã¼ã‹ã—ã€€è„±ç™½é«ªæŸ“ã‚ã€€ãƒã‚¤ãƒ©ã‚¤ãƒˆã€€ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã€€ç¸®æ¯›çŸ¯æ­£ã€€é«ªè³ªæ”¹å–„';
      alert('å›ºå®šã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
    } else {
      alert('ã‚¨ãƒ‡ã‚£ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
  };


// UIè¡¨ç¤ºåˆ‡æ›¿
document.getElementById("aiBlogBtn").onclick = () => {
  const input = document.getElementById("aiPromptInput");
  const exec = document.getElementById("aiExecBtn");
  const show = input.style.display === "none";
  input.style.display = show ? "block" : "none";
  exec.style.display = show ? "inline-block" : "none";
};


// ã€Œã“ã®å†…å®¹ã§æ›¸ãã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
document.getElementById("aiExecBtn").onclick = async () => {
  const input = document.getElementById("aiPromptInput");
  await generateAIBlog(input.value.trim());
};

// ç”Ÿæˆå‡¦ç†æœ¬ä½“ï¼ˆå…±é€šé–¢æ•°ï¼‰
async function generateAIBlog(prompt) {
  if (!prompt) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  showLoading("AIã§ç”Ÿæˆä¸­...");

  try {
    const res = await fetch(GEMINI_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼ã®ãƒ–ãƒ­ã‚°è¨˜äº‹ã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒã«é–¢ã™ã‚‹æ–‡ç« ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆ600ã€œ800æ–‡å­—ï¼‰:\n\n${prompt}`
          }]
        }]
      })
    });

    const data = await res.json();
    const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!aiText) throw new Error("ç”ŸæˆçµæœãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");

    const editor = document.querySelector('.nicEdit-main');
    if (editor) {
      editor.innerHTML += "<br><br>" + aiText.replace(/\n/g, "<br>");

    }

    alert("AIè¨˜äº‹ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ");
  } catch (err) {
    console.error("AIç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
    alert("AIç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
  } finally {
    hideLoading();
    const input = document.getElementById("aiPromptInput");
    const exec = document.getElementById("aiExecBtn");
    input.style.display = "none";
    exec.style.display = "none";
    input.value = '';
  }
}


  document.getElementById("addCandidate").onclick = () => {
    const data = getFormData();
    showLoading("å€™è£œã‚’ç™»éŒ²ä¸­...");
    fetch(BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams(data).toString()
    }).then(() => {
      hideLoading();
      alert("å€™è£œã«ç™»éŒ²ã—ã¾ã—ãŸ");
      loadData();
    });
  };

  document.getElementById("confirmSelected").onclick = () => {
    const selected = candidateData.filter(item => document.querySelector(`input[data-index='${item.index}']`)?.checked);
    if (selected.length === 0) return alert("é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
    showLoading("ç¢ºå®šãƒªã‚¹ãƒˆã¸é€ä¿¡ä¸­...");
    fetch(BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'confirm',
        indexList: JSON.stringify(selected.map(item => item.index))
      }).toString()
    }).then(() => {
      hideLoading();
      alert("ä¸€æ‹¬ç¢ºå®šã—ã¾ã—ãŸ");
      loadData();
    });
  };

  document.getElementById("deleteSelected").onclick = () => {
    const selectedIndexes = candidateData
      .filter(item => document.querySelector(`input[data-index='${item.index}']`)?.checked)
      .map(item => item.index);

    if (selectedIndexes.length === 0) return alert("å‰Šé™¤å¯¾è±¡ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
    showLoading("å‰Šé™¤ä¸­...");
    fetch(BASE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: "delete",
        indexList: JSON.stringify(selectedIndexes)
      }).toString()
    }).then(() => {
      hideLoading();
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      loadData();
    });
  };

  loadData();
})();
